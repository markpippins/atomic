services:
  # Databases
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
      MYSQL_DATABASE: userdb
    ports:
      - "3306:3306"
    command: --init-file /data/application/init.sql
    volumes:
      - mysql_data:/var/lib/mysql
      - ./init-mysql.sql:/data/application/init.sql

  mongodb:
    image: mongo:7
    environment:
      MONGO_INITDB_ROOT_USERNAME: mongoUser
      MONGO_INITDB_ROOT_PASSWORD: somePassword
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db

  # Spring Boot Services
  broker-gateway:
    build: ./spring/broker-gateway
    ports:
      - "8080:8080"
    depends_on:
      - mongodb
      - file-system-server
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongodb:27017/brokergateway

  user-access-service:
    build: ./spring/user-access-service
    ports:
      - "8081:8081"
    depends_on:
      - mysql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/user_service?createDatabaseIfNotExist=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass

  login-service:
    build: ./spring/login-service
    ports:
      - "8082:8082"
    depends_on:
      - user-access-service

  user-service:
    build: ./spring/user-service
    ports:
      - "8083:8083"
    depends_on:
      - mongodb
    environment:
      - SPRING_DATA_MONGODB_URI=mongodb://mongodb:27017/userservice

  host-server:
    build: ./spring/host-server
    ports:
      - "8085:8085"
    depends_on:
      - mysql
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/services_console?createDatabaseIfNotExist=true
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=rootpass
      - BROKER_GATEWAY_URL=http://broker-gateway:8080

  # Helidon Services
  satellite:
    build: ./helidon/satellite
    ports:
      - "9093:9093"
    depends_on:
      - host-server
    environment:
      - host.server.url=http://host-server:8085
      - service.name=satellite
      - service.host=satellite
      - registration.enabled=true
      - heartbeat.interval.seconds=30
      - server.port=9093

  # Node.js Services
  moleculer-search:
    build: ./node/moleculer-search
    ports:
      - "4050:4050"
    depends_on:
      - host-server
    environment:
      - SERVICE_REGISTRY_URL=http://host-server:8085/api/registry
      - SERVICE_HOST=moleculer-search
      - SERVICE_PORT=4050
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_SEARCH_ENGINE_ID=${GOOGLE_SEARCH_ENGINE_ID}

  file-system-server:
    build: ./node/file-system-server
    ports:
      - "4040:4040"
    environment:
      - FS_SERVER_PORT=4040

  # Web Applications
  nextjs-api-tester:
    build: ./web/nextjs-api-tester
    ports:
      - "9012:9012"
    depends_on:
      - broker-gateway

  nextjs-cool-people:
    build: ./web/nextjs-cool-people
    ports:
      - "9002:9002"
    depends_on:
      - broker-gateway

volumes:
  mysql_data:
  mongo_data: